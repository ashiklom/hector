---
title: Different RCPs in Hector
author: Alexey Shiklomanov
---

# Introduction

Hector ships with several different scenarios: RCP 2.6, 4.5, 6.0, and 8.5.
(Background on scenarios).

# Run the scenarios

The configurations for each of these scenarios can be obtained from the INI files, named according to the pattern `input/hector_rcpXX.ini`, and which can be accessed via `system.file`.

Here, we create a named vector of INI files.
The names will propagate through all the objects generated by the `Map` functions, which will make it easy to keep track of everything.

```{r}
library(hector)

pathways <- c("26", "45", "60", "85")
ini_filenames <- sprintf("input/hector_rcp%s.ini", pathways)
ini_files <- system.file(ini_filenames, package = "hector")
names(ini_files) <- paste0("RCP", pathways)
ini_files
```

Next, we initialize a core for each scenario.
Note that names are preserved, allowing us to refer to these cores by informative names later on.

```{r}
cores <- Map(newcore, ini_files)
cores
```

Next, we run each core.
Recall that the `run` function returns no output.

```{r}
runs <- Map(run, cores)
```

Next, we retrieve results from each core and combine them into a single `data.frame`.

```{r}
get_result_from_core <- function(core, label) {
  result <- fetchvars(core, 2000:2300)
  result[["scenario"]] <- label
  result
}

results_list <- Map(get_result_from_core, cores, names(cores))
results <- Reduce(rbind, results_list)
results[["var_unit"]] <- with(results, sprintf("%s (%s)", variable, units))
head(results)
```

Finally, we plot the results using `ggplot`.

```{r}
library(ggplot2)
ggplot(results) +
  aes(x = year, y = value, color = scenario, group = scenario) +
  geom_line() +
  facet_wrap(~var_unit, scales = "free_y")
```

# A closer look

Let's look more carefully at what's underneath each scenario.

Emissions data for each scenario are stored in files `input/emissions/RCPXX_emissions.csv` (except that RCP 6.0, inconsistently, drops the trailing zero).

```{r}
emissions_filenames <- sprintf("input/emissions/RCP%s_emissions.csv", c("26", "45", "6", "85"))
emissions_files <- system.file(emissions_filenames, package = "hector")
names(emissions_files) <- names(ini_files)
emissions_files
```

Now, let's read these data in.
Note that the first 3 lines of each emissions file are metadata, the column names are on line 4, and the actual data start on line 5.

```{r}
read_emissions <- function(filename, pathway) {
  data <- read.csv(filename, skip = 3, stringsAsFactors = FALSE, header = TRUE)
  data[["pathway"]] <- pathway
  data
}
emissions_data_list <- Map(read_emissions, emissions_files, names(emissions_files))
emissions_data <- Reduce(rbind, emissions_data_list)
emissions_data[1:5, 1:5]
```

Now, let's re-format the data into a "long" format using `tidyr::gather` and plot them.
To make this a little more manageable, we only plot six of the 40 emissions trajectories Hector uses.

```{r}
library(tidyr)
emissions_long <- gather(emissions_data, key = "variable", value = "value", -Date, -pathway)
head(emissions_long)

use_emissions <- c(
  "BC_emissions",                       # Black carbon
  "ffi_emissions",                      # Fossil fuels
  "CH4_emissions",                      # Methane
  "luc_emissions",                      # Land-use change
  "N2O_emissions",
  "SO2_emissions"
)


ggplot(subset(emissions_long, variable %in% use_emissions)) +
  aes(x = Date, y = value, color = pathway, group = pathway) +
  geom_line() +
  facet_wrap(~variable, scales = "free_y") +
  xlim(1980, 2100)
```

Although it is tempting to reduce the RCPs to the global temperature increases the cause by 2100, these figures show that there is a lot more behind these scenarios.
For example, although it is the most aggressive emissions reduction pathway, RCP 2.6 actually has the largest emissions from land-use change while RCP 6.0--the second-most severe pathway--has significant carbon _sequestration_ from land use change.
Similarly, RCP 8.5 has dramatically higher fossil fuel emissions than RCP 4.5, especially in the latter half of the 21st Century, but both scenarios have very similar trajectories of SO2 emissions.

# Parameter vs. scenario uncertainty

The time series tell interesting stories about the socio-economic trajectories behind each of these scenarios.
However, to a first approximation, the RCPs can be summarized by the cumulative sums of emissions for each trajectory.

```{r}
emissions_cols <- unique(emissions_long$variable)
emissions_data_sub <- subset(emissions_data, Date > 2000, Date <= 2100)
emissions_cumulative <- aggregate(emissions_data_sub[, emissions_cols], by = list(pathway = emissions_data_sub[["pathway"]]), sum)
emissions_cumulative_tidy <- gather(emissions_cumulative, "variable", "value", -pathway)
head(emissions_cumulative_tidy, 10)
```
